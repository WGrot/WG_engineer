@using RestaurantApp.Blazor.Models

<div class="availability-map">
    @if (!string.IsNullOrEmpty(_trimmedAvailability))
    {
        @for (int i = 0; i < _trimmedAvailability.Length; i++)
        {
            char state = _trimmedAvailability[i];
            var time = StartTime.AddMinutes(i * 15 + _leading2S * 15);
            bool isHourMark = time.Minute == 0;
            bool isSelected = IsTimeInSelectedRange(time);

            string slotClass = state switch
            {
                '1' => "available",
                '2' => "closed",
                _ => "unavailable"
            };

            if (isSelected)
            {
                slotClass += " selected";
            }

            <div class="slot-container" @onclick="() => OnSlotClick(time, slotClass)">
                @if (isHourMark)
                {
                    <div class="hour-marker" title="@time.ToString("HH:mm")">
                        <div class="hour-label">@time.ToString("HH:mm")</div>
                    </div>
                }
                <div class="slot @slotClass"
                     title="@($"{time:HH:mm} - {slotClass}")">
                </div>
            </div>
        }
    }
</div>


@code {
    [Parameter] public string? Availability { get; set; }
    [Parameter] public DateTime StartTime { get; set; } = DateTime.Today;
    [Parameter] public DateTime SelectedStartTime { get; set; }
    [Parameter] public DateTime SelectedEndTime { get; set; }
    [Parameter] public EventCallback<SlotClickedArgs> OnSlotClicked { get; set; }

    private string? _trimmedAvailability;
    private int _leading2S = 0;
    private DateTime _adjustedStartTime;

    protected override void OnParametersSet()
    {
        _trimmedAvailability = TrimEdges(Availability);
        _adjustedStartTime = StartTime.AddMinutes(_leading2S * 15);
    }

    private string? TrimEdges(string? input)
    {
        if (string.IsNullOrEmpty(input))
            return input;

        _leading2S = input.TakeWhile(c => c == '2').Count();

        if(_leading2S > 95) 
            return input;

        return input.Trim('2');
    }

    private bool IsTimeInSelectedRange(DateTime time)
    {
        if (SelectedStartTime == DateTime.MinValue)
            return false;
        
        if (SelectedEndTime == DateTime.MinValue)
            return time == SelectedStartTime;
        
        var min = SelectedStartTime < SelectedEndTime ? SelectedStartTime : SelectedEndTime;
        var max = SelectedStartTime > SelectedEndTime ? SelectedStartTime : SelectedEndTime;

        return time >= min && time < max;
    }

    private async Task OnSlotClick(DateTime time, string status)
    {
        await OnSlotClicked.InvokeAsync(new SlotClickedArgs
        {
            Time = time,
            Status = status
        });
    }
}