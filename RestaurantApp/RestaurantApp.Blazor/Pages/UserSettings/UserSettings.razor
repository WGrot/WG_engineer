@page "/UserSettings"
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using RestaurantApp.Blazor.Components.Layout
@using RestaurantApp.Blazor.Services
@using RestaurantApp.Shared.DTOs.Users
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider
@inject PermissionService PermissionService

<AuthorizeView>
    <Authorized>

        <div class="restaurant-header bg-primary text-white">
            <div class="container py-4">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <div class="text-white">
                            <i class="bi bi-person-circle" style="font-size: 4.5rem;"></i>
                        </div>
                    </div>
                    <div class="col-auto">
                        <h1 class="h2 mb-1">@(userDto.FirstName + " " + userDto.LastName)</h1>
                        <p class="mb-0 opacity-75">
                            <i class="bi bi-envelope me-1"></i>
                            @userDto.Email
                        </p>
                        @if(!string.IsNullOrEmpty(userDto.PhoneNumber)){
                            <p class="mb-0 opacity-75">
                                <i class="bi bi-telephone"></i>
                                @userDto.PhoneNumber
                            </p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-light border-bottom sticky-top">
            <div class="container">
                <ul class="nav nav-tabs nav-fill border-0 pt-2" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link @(activeTab == "info" ? "active" : "") px-4 py-3 border-0 rounded-top"
                                @onclick="@(() => activeTab = "info")"
                                type="button">
                            <i class="bi bi-info-circle me-2"></i>
                            Info
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link @(activeTab == "security" ? "active" : "") px-4 py-3 border-0 rounded-top"
                                @onclick="@(() => activeTab = "security")"
                                type="button">
                            <i class="bi bi-shield-lock me-2"></i>
                            Security Settings
                        </button>
                    </li>
                    @if (isEmployee)
                    {
                        <li class="nav-item">
                            <button class="nav-link @(activeTab == "employee-settings" ? "active" : "") px-4 py-3 border-0 rounded-top"
                                    @onclick="@(() => activeTab = "employee-settings")"
                                    type="button">
                                <i class="bi bi-person-badge me-2"></i>
                                Employee Info
                            </button>
                        </li>
                    }
                </ul>
            </div>
        </div>

        <div class="container my-4">
            <div class="tab-content">
                @switch (activeTab)
                {
                    case "info":
                        <div class="tab-pane fade show active">
                            <UserInfo user="userDto" UserChanged="OnUserChanged"/>
                        </div>
                        break;
                    case "security":
                        <div class="tab-pane fade show active">
                            <SecuritySettings />
                        </div>
                        break;
                    case "employee-settings":
                        <div class="tab-pane fade show active">
                            <EmployeeSettings UserId="@userDto.Id"/>
                        </div>
                        break;
                }
            </div>
        </div>

    </Authorized>
    <NotAuthorized>
        <RedirectToLogin UseReturnUrl="true"/>
    </NotAuthorized>
</AuthorizeView>

@code {
    ResponseUserDto userDto = new ResponseUserDto();
    ClaimsPrincipal currentUser = new ClaimsPrincipal();
    private string currentUserId = "";
    string activeTab = "info";
    private bool isEmployee = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserData();
    }

    private async Task LoadUserData()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        currentUser = authState.User;
        if (currentUser.Identity?.IsAuthenticated == true)
        {
            currentUserId = currentUser.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        }
        isEmployee = await PermissionService.IsEmployeeAsync();
        userDto = await Http.GetFromJsonAsync<ResponseUserDto>($"api/User/{currentUserId}");
    }

    private void OnUserChanged(ResponseUserDto updatedUser)
    {
        userDto = updatedUser;
    }
}