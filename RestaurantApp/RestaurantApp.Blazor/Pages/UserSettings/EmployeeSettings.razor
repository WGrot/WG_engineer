@using RestaurantApp.Blazor.Services
@using RestaurantApp.Shared.DTOs.Employees
@using RestaurantApp.Shared.DTOs.Permissions
@using RestaurantApp.Blazor.Components
@inject HttpClient Http
@inject AuthService Auth
<div calss = "container mt-4">
    <h3 class="mb-4 fw-bold text-center">
        User employment and permissions info
    </h3>
    <div class="row g-3 justify-content-center">
        @foreach (var employeeDto in _employeeDtos)
        {
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-primary d-flex justify-content-between align-items-center text-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-shop"></i> @employeeDto.Restaurant.Name
                        </h5>

                        <button class="btn btn-outline-light" @onclick="() => { ShowDeleteConfirmation(); EmployeeIdToDelete = employeeDto.Id; }">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <span class="badge bg-primary fs-6">@employeeDto.RoleEnumDto.ToString()</span>
                        </div>

                        <h6 class="text-muted mb-2">Permissions:</h6>
                        <ul class="list-unstyled">
                            @foreach (var permission in employeeDto.Permissions)
                            {
                                <li class="mb-1">
                                    <i class="bi bi-check-circle-fill text-secondary"></i>
                                    @permission.Permission.ToString()
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        }
    </div>
    
</div>

<ConfirmationModal @bind-IsVisible="ShowConfirmDelete"
                   Title="Confirm Deletion"
                   Message="Are you sure you want to delete this employee entry?
                            All associated permissions will also be removed. You will no longer have access to this restaurant!
                            You will be logged out upon deletion."
                   OnConfirm="DeleteEmployment"/>




@code {
    [Parameter] public string UserId { get; set; }
    private bool ShowConfirmDelete { get; set; }
    private int EmployeeIdToDelete { get; set; }
    private void ShowDeleteConfirmation() => ShowConfirmDelete = true;
    
    private List<RestaurantEmployeeDto> _employeeDtos = new();
    protected override async Task OnInitializedAsync()
    {
        _employeeDtos = await Http.GetFromJsonAsync<List<RestaurantEmployeeDto>>($"/api/Employees?userId={UserId}");
        foreach (var dto in _employeeDtos)
        {
            List<RestaurantPermissionDto> permissions = await GetPermissions(dto);
            dto.Permissions = permissions;
        }
    }
    
    private async Task<List<RestaurantPermissionDto>> GetPermissions(RestaurantEmployeeDto dto)
    {
        return await Http.GetFromJsonAsync<List<RestaurantPermissionDto>>($"/api/Permissions/employee/{dto.Id}");
    }
    
    private async Task DeleteEmployment()
    {
        var result = await Http.DeleteAsync($"/api/Employees/{EmployeeIdToDelete}");
        if (result.IsSuccessStatusCode)
        {
            await Auth.LogoutAsync();
        }
        ShowConfirmDelete = false;
    }
} 