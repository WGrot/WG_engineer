@using System.Net
@using System.Security.Claims
@using System.Text.Json
@using RestaurantApp.Blazor.Services
@using RestaurantApp.Shared.DTOs.Auth.TwoFactor
@using RestaurantApp.Blazor.Components
@using RestaurantApp.Blazor.Services.Interfaces
@using RestaurantApp.Shared.Common
@using RestaurantApp.Shared.DTOs.Auth
@using RestaurantApp.Shared.DTOs.Users
@using RestaurantApp.Shared.Models
@inject HttpClient Http
@inject NotificationService NotificationService
@inject ICurrentUserDataService userDataService

<div class="container">
    <div class="row">
        <div class="col-12 col-lg-8 col-xl-6 mx-auto">

            <div class="text-center w-100">
                <h3 class="mb-3 fw-bold">Security Settings</h3>
                <p class="text-muted">Manage your account security and authentication methods</p>
            </div>



            
            
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-key"></i> Password
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-start">
                        <div class="flex-grow-1">
                            <p class="card-text text-muted small mb-3">
                                Change your password to keep your account secure. Use a strong, unique password.
                            </p>
                            <button class="button button--primary button--outline w-100" @onclick="() => showChangePasswordModal = true">
                                <i class="bi bi-pencil me-2"></i>Change Password
                            </button>
                        </div>
                    </div>
                </div>
            </div>


            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0 d-flex align-items-center">
                        <div class="d-flex align-items-center ms-2">
                            @if (is2FAEnabled)
                            {
                                <i class="bi bi-shield-check"></i>
                            }
                            else
                            {
                                <i class="bi bi-shield-fill-exclamation"></i>
                            }
                        </div>
                        <span class="ms-2">Two-Factor Authentication</span>
                    </h5>

                </div>
                <div class="card-body">
                    <div class="d-flex align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                @if (is2FAEnabled)
                                {
                                    <span class="badge bg-success">Enabled</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning">Disabled</span>
                                }
                            </div>
                            <p class="card-text text-muted small mb-3">
                                @if (is2FAEnabled)
                                {
                                    <text>Your account is protected with two-factor authentication. You'll need to enter a code from your authenticator app when signing in.</text>
                                }
                                else
                                {
                                    <text>Add an extra layer of security to your account. You'll need to enter a code from your authenticator app when signing in.</text>
                                }
                            </p>
                            @if (is2FAEnabled)
                            {
                                <button class="button button--red button--outline w-100" @onclick="OpenDisable2FAModal">
                                    <i class="bi bi-shield-x me-2"></i>Disable 2FA
                                </button>
                            }
                            else
                            {
                                <button class="button button--primary button--outline w-100" @onclick="OpenEnable2FAModal">
                                    <i class="bi bi-shield-check me-2"></i>Enable 2FA
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>


            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0 d-flex align-items-center">
                        <div class="d-flex align-items-center ms-2">
                            @if (isEmailVerified)
                            {
                                <i class="bi bi-envelope-check"></i>
                            }
                            else
                            {
                                <i class="bi bi-envelope-exclamation"></i>
                            }
                        </div>
                        <span class="ms-2">E-mail verification</span>
                    </h5>

                </div>
                <div class="card-body">
                    <div class="d-flex align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                @if (isEmailVerified)
                                {
                                    <span class="badge bg-success">Verified</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning">Not Verified</span>
                                }
                            </div>
                            <p class="card-text text-muted small">
                                @if (isEmailVerified)
                                {
                                    <text>Your email is verified. Your account is secure.</text>
                                }
                                else
                                {
                                    <div class="mb-3">Your email is not verified. Please verify your email to secure your account and access all features.</div>
                                    <button class="button button--primary button--outline w-100" @onclick="SendVerifyEmail">
                                        <i class="bi bi-shield-check me-2"></i>Verify your e-mail
                                    </button>
                                }
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-search me-2"></i>
                        Allow searching for profile
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch">
                        <input class="form-check-input"
                               style="cursor: pointer;"
                               type="checkbox"
                               id="needConfirmationCheckbox"
                               checked="@userDetails.CanBeSearched"
                               @onchange="@(() => { _ = ToggleCanBeSearched();})">
                        <label class="form-check-label" style="cursor: pointer;" for="needConfirmationCheckbox">
                            Allow restaurant owner to search for your profile
                        </label>
                    </div>
                    <small class="text-muted d-block mt-2">
                        <i class="bi bi-info-circle me-1"></i>
                        When enabled, restaurant owners can search for your profile. Ignore if you are not  planning to become an employee.
                    </small>
                </div>
            </div>
            
        </div>
    </div>
</div>

<ChangePasswordModal
    @bind-IsVisible="showChangePasswordModal"
></ChangePasswordModal>

<Enable2FaModal
    @bind-IsVisible="showEnable2FAModal"
    CurrentUserId="currentUserId"
    Enable2FAData="enable2FAData"
    On2FAEnabled="Handle2FAEnabled"
/>

<TwoFactorModal
    IsVisible="showDisable2FAModal"
    IsLoading="isDisabling2FA"
    ErrorMessage="@disable2FAErrorMessage"
    WarningMessage="This action will disable two-factor authentication. Your account will be less secure."
    Title="Disable Two-Factor Authentication"
    Description="Please enter your 2FA code to confirm disabling two-factor authentication"
    SubmitButtonText="Disable 2FA"
    SubmitButtonClass="button--red"
    LoadingText="Disabling..."
    OnSubmit="HandleDisable2FA"
    OnCancel="CancelDisable2FA"
/>


@code {
    [Inject]
    public JwtAuthenticationStateProvider AuthStateProvider { get; set; } = default!;

    [Inject] public AuthService Auth { get; set; } = default!;

    private bool showChangePasswordModal = false;
    private bool showEnable2FAModal = false;
    private bool showDisable2FAModal = false;

    private string currentUserId;
    private bool is2FAEnabled = false;
    private Enable2FAResponse? enable2FAData = null;
    UserDetailsDto userDetails = new();
    
    private bool isEmailVerified = false;
    private bool isDisabling2FA = false;
    private string? disable2FAErrorMessage = null;
    
    private string emailErrorMessage = string.Empty;
    private string emailSuccessMessage = string.Empty;

    
    protected override async Task OnInitializedAsync()
    {

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var currentUser = authState.User;
        if (currentUser.Identity?.IsAuthenticated == true)
        {
            currentUserId = currentUser.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        }
        var response = await Http.GetFromJsonAsync<UserDetailsDto>($"api/User/my-details");

        if (response != null)
        {
            userDetails = response;
        }

    }

    private void OpenDisable2FAModal()
    {
        disable2FAErrorMessage = null;
        showDisable2FAModal = true;
    }

    private async Task HandleDisable2FA(string code)
    {
        isDisabling2FA = true;
        disable2FAErrorMessage = null;

        try
        {
            var dto = new Verify2FARequest
            {
                UserId = currentUserId,
                Code  = code
            };

            var response = await Http.PostAsJsonAsync("api/TwoFactor/disable", dto);

            if (response.IsSuccessStatusCode)
            {
                is2FAEnabled = false;
                showDisable2FAModal = false;
            }
            else
            {
                disable2FAErrorMessage = "Invalid 2FA code. Please try again.";
            }
        }
        catch (Exception ex)
        {
            disable2FAErrorMessage = "An error occurred. Please try again.";
            Console.WriteLine($"Error disabling 2FA: {ex.Message}");
        }
        finally
        {
            isDisabling2FA = false;
        }
    }

    private void CancelDisable2FA()
    {
        showDisable2FAModal = false;
        disable2FAErrorMessage = null;
    }

    private async Task OpenEnable2FAModal()
    {
        var dto = new Enable2FARequest
        {
            UserId = currentUserId
        };

        var response = await Http.PostAsJsonAsync("api/TwoFactor/enable", dto);

        if (response.IsSuccessStatusCode)
        {
            enable2FAData = await response.Content.ReadFromJsonAsync<Enable2FAResponse>();
            showEnable2FAModal = true;
        }
    }
    private async Task ToggleEmployeeVisibility()
    {
        showEnable2FAModal = false;
    }

    private async Task Handle2FAEnabled()
    {
        is2FAEnabled = true;
    }
    
    private async Task ToggleCanBeSearched()
    {
        userDetails.CanBeSearched = !userDetails.CanBeSearched;
        var dto = new UpdateUserDto()
        {
            Id = userDetails.Id,
            CanBeSearched = userDetails.CanBeSearched
        };

        var response = await Http.PatchAsJsonAsync($"api/User/{userDetails.Id}", dto);

        if (!response.IsSuccessStatusCode)
        {
            userDetails.CanBeSearched = !userDetails.CanBeSearched;
        }
    }
    
    private async Task SendVerifyEmail()
    {
        try
        {
            ResendEmailRequest content = new ResendEmailRequest
            {
                Email = userDetails.Email!
            };
            

            var response = await Http.PostAsJsonAsync("/api/Auth/resend-confirmation-email", content);
            
            if (response.IsSuccessStatusCode)
            {
                emailSuccessMessage = "Verification email sent successfully! Please check your inbox.";
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                
                try
                {
                    var errorResponse = JsonSerializer.Deserialize<Dictionary<string, object>>(errorContent);
                    if (errorResponse != null && errorResponse.ContainsKey("message"))
                    {
                        emailErrorMessage = errorResponse["message"].ToString() ?? "Failed to send verification email.";
                    }
                    else
                    {
                        emailErrorMessage = "Failed to send verification email. Please try again later.";
                    }
                }
                catch
                {
                    emailErrorMessage = "Failed to send verification email. Please try again later.";
                }
            }
        }
        catch (Exception ex)
        {
            emailErrorMessage = $"An error occurred: {ex.Message}";
            Console.WriteLine($"Resend verification error: {ex}");
        }
        finally
        {
            if (!string.IsNullOrEmpty(emailSuccessMessage))
            {
                NotificationService.AddNotification(new Notification()
                {
                    Title = "Success",
                    Content = emailSuccessMessage,
                    Type = NotificationType.Success,
                });
            }
            else
            {
                NotificationService.AddNotification(new Notification()
                {
                    Title = "Error",
                    Content = emailErrorMessage,
                    Type = NotificationType.Error,
                });
            }
            
            StateHasChanged();
        }
    }
}