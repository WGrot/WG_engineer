@using System.Net
@using System.Security.Claims
@using RestaurantApp.Blazor.Services
@using RestaurantApp.Shared.DTOs.Auth.TwoFactor
@using RestaurantApp.Blazor.Components
@inject HttpClient Http

<div class="container">
    <div class="row">
        <div class="col-12 col-lg-8 col-xl-6 mx-auto">
            <!-- Header -->
            <div class="text-center w-100">
                <h3 class="mb-3 fw-bold">Security Settings</h3>
                <p class="text-muted">Manage your account security and authentication methods</p>
            </div>


            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="d-flex align-items-start">
                        <div class="flex-shrink-0 me-3">
                            <div class="bg-primary bg-opacity-10 rounded p-3">
                                <i class="bi bi-key-fill fs-4 text-white"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-2">Password</h5>
                            <p class="card-text text-muted small mb-3">
                                Change your password to keep your account secure. Use a strong, unique password.
                            </p>
                            <button class="button button--primary button--outline" @onclick="() => showChangePasswordModal = true">
                                <i class="bi bi-pencil me-2"></i>Change Password
                            </button>
                        </div>
                    </div>
                </div>
            </div>


            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="d-flex align-items-start">
                        <div class="flex-shrink-0 me-3">
                            <div class="@(is2FAEnabled ? "bg-success" : "bg-warning") bg-opacity-10 rounded p-3">
                                <i class="bi bi-shield-check fs-4 @(is2FAEnabled ? "text-success" : "text-warning")"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <h5 class="card-title mb-0 me-2">Two-Factor Authentication</h5>
                                @if(is2FAEnabled)
                                {
                                    <span class="badge bg-success">Enabled</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Disabled</span>
                                }
                            </div>
                            <p class="card-text text-muted small mb-3">
                                @if(is2FAEnabled)
                                {
                                    <text>Your account is protected with two-factor authentication. You'll need to enter a code from your authenticator app when signing in.</text>
                                }
                                else
                                {
                                    <text>Add an extra layer of security to your account. You'll need to enter a code from your authenticator app when signing in.</text>
                                }
                            </p>
                            @if(is2FAEnabled)
                            {
                                <button class="button button--red button--outline" @onclick="OpenDisable2FAModal">
                                    <i class="bi bi-shield-x me-2"></i>Disable 2FA
                                </button>
                            }
                            else
                            {
                                <button class="button button--primary button--outline" @onclick="OpenEnable2FAModal">
                                    <i class="bi bi-shield-check me-2"></i>Enable 2FA
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<ChangePasswordModal
    @bind-IsVisible="showChangePasswordModal"
></ChangePasswordModal>

<Enable2FaModal
    @bind-IsVisible="showEnable2FAModal"
    CurrentUserId="currentUserId"
    Enable2FAData="enable2FAData"
    On2FAEnabled="Handle2FAEnabled"
/>

<TwoFactorModal
    IsVisible="showDisable2FAModal"
    IsLoading="isDisabling2FA"
    ErrorMessage="@disable2FAErrorMessage"
    WarningMessage="This action will disable two-factor authentication. Your account will be less secure."
    Title="Disable Two-Factor Authentication"
    Description="Please enter your 2FA code to confirm disabling two-factor authentication"
    SubmitButtonText="Disable 2FA"
    SubmitButtonClass="button--red"
    LoadingText="Disabling..."
    OnSubmit="HandleDisable2FA"
    OnCancel="CancelDisable2FA"
/>


@code {
    [Inject]
    public JwtAuthenticationStateProvider AuthStateProvider { get; set; } = default!;

    [Inject] public AuthService Auth { get; set; } = default!;

    private bool showChangePasswordModal = false;
    private bool showEnable2FAModal = false;
    private bool showDisable2FAModal = false;

    private string currentUserId;
    private bool is2FAEnabled = false;
    private Enable2FAResponse? enable2FAData = null;
    
    private bool isDisabling2FA = false;
    private string? disable2FAErrorMessage = null;

    protected override async Task OnInitializedAsync()
    {
        is2FAEnabled = await Auth.IsTwoFactorEnabledAsync();

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var currentUser = authState.User;
        if (currentUser.Identity?.IsAuthenticated == true)
        {
            currentUserId = currentUser.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        }
    }

    private void OpenDisable2FAModal()
    {
        disable2FAErrorMessage = null;
        showDisable2FAModal = true;
    }

    private async Task HandleDisable2FA(string code)
    {
        isDisabling2FA = true;
        disable2FAErrorMessage = null;

        try
        {
            var dto = new Verify2FARequest
            {
                UserId = currentUserId,
                Code  = code
            };

            var response = await Http.PostAsJsonAsync("api/TwoFactor/disable", dto);

            if (response.IsSuccessStatusCode)
            {
                is2FAEnabled = false;
                showDisable2FAModal = false;
                Console.WriteLine("2FA został wyłączony!");
            }
            else
            {
                disable2FAErrorMessage = "Invalid 2FA code. Please try again.";
            }
        }
        catch (Exception ex)
        {
            disable2FAErrorMessage = "An error occurred. Please try again.";
            Console.WriteLine($"Error disabling 2FA: {ex.Message}");
        }
        finally
        {
            isDisabling2FA = false;
        }
    }

    private void CancelDisable2FA()
    {
        showDisable2FAModal = false;
        disable2FAErrorMessage = null;
    }

    private async Task OpenEnable2FAModal()
    {
        var dto = new Enable2FARequest
        {
            UserId = currentUserId
        };

        var response = await Http.PostAsJsonAsync("api/TwoFactor/enable", dto);

        if (response.IsSuccessStatusCode)
        {
            enable2FAData = await response.Content.ReadFromJsonAsync<Enable2FAResponse>();
            showEnable2FAModal = true;
        }
    }

    private async Task Handle2FAEnabled()
    {
        is2FAEnabled = true;
        Console.WriteLine("2FA został włączony!");
    }
}