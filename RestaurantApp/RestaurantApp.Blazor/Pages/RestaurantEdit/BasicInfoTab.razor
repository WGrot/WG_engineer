@using RestaurantApp.Blazor.Extensions
@using RestaurantApp.Blazor.Models.DTO
@using RestaurantApp.Shared.DTOs
@using RestaurantApp.Shared.DTOs.GeoCoding
@using RestaurantApp.Shared.DTOs.Restaurant
@using RestaurantApp.Shared.Models
@inject HttpClient Http

@if (restaurant != null)
{
    <div class="container mt-4">
        <div class="row justify-content-evenly">
            <div class="col-lg-8 col-12 w-100">
                <div>
                    <div class="text-center w-100">
                        <h3 class="mb-3">Change basic information regarding restaurant</h3>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3 h-100">
                            <label for="name" class="form-label">
                                Restaurant name <span class="text-danger">*</span>
                            </label>
                            <input type="text"
                                   class="form-control @(string.IsNullOrWhiteSpace(modifiedRestaurant.Name) ? "is-invalid" : "")"
                                   id="name"
                                   @bind="modifiedRestaurant.Name"
                                   @bind:after="OnFieldChanged"
                                   required/>
                            @if (string.IsNullOrWhiteSpace(modifiedRestaurant.Name))
                            {
                                <div class="invalid-feedback">Restaurant name is required</div>
                            }

                            <label for="description" class="form-label">
                                Restaurant description: <span class="text-danger">*</span>
                            </label>
                            <textarea
                                class="form-control"
                                id="description"
                                rows="8"
                                @bind="modifiedRestaurant.Description"
                                @bind:after="OnFieldChanged">
                            </textarea>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="street" class="form-label">
                                Street and number: <span class="text-danger">*</span>
                            </label>
                            <input class="form-control @(string.IsNullOrWhiteSpace(modifiedRestaurant.StructuredAddress?.Street) ? "is-invalid" : "")"
                                   id="street"
                                   @bind="modifiedRestaurant.StructuredAddress.Street"
                                   @bind:after="OnAddressFieldChanged"
                                   required/>
                            @if (string.IsNullOrWhiteSpace(modifiedRestaurant.StructuredAddress?.Street))
                            {
                                <div class="invalid-feedback">Street is required</div>
                            }

                            <label for="city" class="form-label">
                                City: <span class="text-danger">*</span>
                            </label>
                            <input class="form-control @(string.IsNullOrWhiteSpace(modifiedRestaurant.StructuredAddress?.City) ? "is-invalid" : "")"
                                   id="city"
                                   @bind="modifiedRestaurant.StructuredAddress.City"
                                   @bind:after="OnAddressFieldChanged"
                                   required/>
                            @if (string.IsNullOrWhiteSpace(modifiedRestaurant.StructuredAddress?.City))
                            {
                                <div class="invalid-feedback">City is required</div>
                            }

                            <label for="postal-code" class="form-label">
                                Postal code: <span class="text-danger">*</span>
                            </label>
                            <input class="form-control"
                                   id="postal-code"
                                   @bind="modifiedRestaurant.StructuredAddress.PostalCode"
                                   @bind:after="OnAddressFieldChanged"
                                   required/>

                            <label for="country" class="form-label">
                                Country: <span class="text-danger">*</span>
                            </label>
                            <input class="form-control @(string.IsNullOrWhiteSpace(modifiedRestaurant.StructuredAddress?.Country) ? "is-invalid" : "")"
                                   id="country"
                                   @bind="modifiedRestaurant.StructuredAddress.Country"
                                   @bind:after="OnAddressFieldChanged"
                                   required/>
                            @if (string.IsNullOrWhiteSpace(modifiedRestaurant.StructuredAddress?.Country))
                            {
                                <div class="invalid-feedback">Country is required</div>
                            }
                        </div>
                    </div>
                </div>

                <div class="col mb-3"></div>

                @if (changesMade && IsFormValid)
                {
                    <div class="row justify-content-center mb-3">
                        <div class="d-flex justify-content-center gap-3">
                            <button class="base-button" @onclick="SaveChanges">Save Changes</button>
                            <button class="grey-button" @onclick="CancelChanges">Cancel</button>
                        </div>
                    </div>
                }

                <h4 class="mb-3 text-center">Opening hours</h4>
                <OpeningHoursTab Id=@Id restaurant=@restaurant/>
            </div>
        </div>
    </div>
}
else
{
    <div class="loading-container">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }
    [Parameter] public required RestaurantDto? restaurant { get; set; }
    private RestaurantDto modifiedRestaurant = new RestaurantDto();
    private bool changesMade = false;
    private bool addressModified = false;

    private bool IsFormValid => 
        !string.IsNullOrWhiteSpace(modifiedRestaurant.Name) &&
        !string.IsNullOrWhiteSpace(modifiedRestaurant.StructuredAddress?.Street) &&
        !string.IsNullOrWhiteSpace(modifiedRestaurant.StructuredAddress?.City) &&
        !string.IsNullOrWhiteSpace(modifiedRestaurant.StructuredAddress?.Country);

    protected override void OnParametersSet()
    {
        if (restaurant != null)
        {
            modifiedRestaurant = new RestaurantDto
            {
                Name = restaurant.Name,
                Description = restaurant.Description,
                Address = restaurant.Address,
                StructuredAddress = restaurant.StructuredAddress != null
                    ? new StructuresAddressDto
                    {
                        Street = restaurant.StructuredAddress.Street,
                        City = restaurant.StructuredAddress.City,
                        PostalCode = restaurant.StructuredAddress.PostalCode,
                        Country = restaurant.StructuredAddress.Country
                    }
                    : new StructuresAddressDto()
            };
        }
    }

    private void OnFieldChanged()
    {
        changesMade = true;
    }

    private void OnAddressFieldChanged()
    {
        changesMade = true;
        addressModified = true;
    }

    private void CancelChanges()
    {
        OnParametersSet();
        changesMade = false;
        addressModified = false;
    }

    private async Task SaveChanges()
    {
        if (!IsFormValid)
            return;

        try
        {
            RestaurantBasicInfoDto dto = new RestaurantBasicInfoDto
            {
                Name = modifiedRestaurant.Name,
                Address = modifiedRestaurant.Address,
                Description = modifiedRestaurant.Description,
            };
            await Http.RequestWithHeaderAsync(HttpMethod.Patch, $"api/restaurant/{Id}/basic-info", dto, "X-Restaurant-Id", Id.ToString());

            if (addressModified)
            {
                var result = await Http.PatchAsJsonAsync($"api/restaurant/{Id}/structured-address", modifiedRestaurant.StructuredAddress);
            }

            changesMade = false;
            addressModified = false;
        }
        catch (Exception e)
        {
            Console.WriteLine($"Error saving data: {e.Message}");
        }
    }
}