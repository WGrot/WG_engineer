@using RestaurantApp.Shared.Models
<h3 class="mb-4">Menu Management</h3>

@if (menu != null)
{
    <div class="container">
        <!-- TAGS SECTION -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Tags Management</h5>
                <button class="btn btn-sm btn-primary" @onclick="ShowAddTagForm">Add New Tag</button>
            </div>
            <div class="card-body">
                @if (showAddTag)
                {
                    <div class="mb-3">
                        <input type="text" class="form-control mb-2" @bind="newTag.Name" placeholder="Tag Name"/>
                        <input type="color" class="form-control form-control-color mb-2" @bind="newTag.ColorHex"/>
                        <button class="btn btn-success btn-sm me-2" @onclick="AddTag">Add</button>
                        <button class="btn btn-secondary btn-sm" @onclick="() => showAddTag = false">Cancel</button>
                    </div>
                }

                <ul class="list-group">
                    @foreach (var tag in tags)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="badge rounded-pill text-white"
                                  style="background-color:@tag.ColorHex">@tag.Name</span>
                            <button class="btn btn-outline-danger btn-sm" @onclick="() => DeleteTag(tag.Id)">Delete
                            </button>
                        </li>
                    }
                </ul>
            </div>
        </div>

        <!-- CATEGORIES SECTION -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Categories</h5>
                <button class="btn btn-sm btn-primary" @onclick="ShowAddCategoryForm">Add New Category</button>
            </div>
            <div class="card-body">
                @if (showAddCategory)
                {
                    <div class="mb-3">
                        <input type="text" class="form-control mb-2" @bind="newCategory.Name"
                               placeholder="Category Name"/>
                        <input type="text" class="form-control mb-2" @bind="newCategory.Description"
                               placeholder="Description"/>
                        <input type="number" class="form-control mb-2" @bind="newCategory.DisplayOrder"
                               placeholder="Display Order"/>
                        <button class="btn btn-success btn-sm me-2" @onclick="AddCategory">Add</button>
                        <button class="btn btn-secondary btn-sm" @onclick="() => showAddCategory = false">Cancel
                        </button>
                    </div>
                }

                <ul class="list-group">
                    @foreach (var category in categories.OrderBy(c => c.DisplayOrder))
                    {
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">@category.Name</h6>
                                <div>
                                    <button class="btn btn-outline-info btn-sm me-1"
                                            @onclick="() => ToggleCategory(category.Id)">
                                        @(expandedCategories.Contains(category.Id) ? "Collapse" : "Expand")
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm me-1"
                                            @onclick="() => editingCategoryId = category.Id">Edit
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm"
                                            @onclick="() => DeleteCategory(category.Id)">Delete
                                    </button>
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(category.Description))
                            {
                                <small class="text-muted">@category.Description</small>
                            }

                            @if (expandedCategories.Contains(category.Id))
                            {
                                <div class="mt-2 ps-3">
                                    <!-- Przycisk dodania -->
                                    <button class="btn btn-sm btn-primary mb-3"
                                            @onclick="() => ShowAddItemForm(category.Id)">
                                        + Add Item
                                    </button>

                                    <!-- Formularz dodawania pozycji -->
                                    @if (showAddItem && addItemToCategoryId == category.Id)
                                    {
                                        <div class="card card-body mb-3 shadow-sm">
                                            <h6 class="fw-bold mb-2">New Item</h6>
                                            <div class="row g-2">
                                                <div class="col-md-6">
                                                    <input type="text" class="form-control" @bind="newItem.Name"
                                                           placeholder="Item Name"/>
                                                </div>
                                                <div class="col-md-6">
                                                    <input type="text" class="form-control" @bind="newItem.Description"
                                                           placeholder="Description"/>
                                                </div>
                                                <div class="col-md-4">
                                                    <input type="number" class="form-control" @bind="newItem.Price"
                                                           placeholder="Price"/>
                                                </div>
                                                <div class="col-md-4">
                                                    <input type="text" class="form-control" @bind="newItem.CurrencyCode"
                                                           placeholder="Currency (PLN)"/>
                                                </div>
                                                <div class="col-md-4">
                                                    <input type="text" class="form-control" @bind="newItem.ImagePath"
                                                           placeholder="Image Path"/>
                                                </div>
                                            </div>

                                            <div class="mt-3">
                                                <button class="btn btn-success btn-sm me-2"
                                                        @onclick="() => AddItem(category.Id)">Add
                                                </button>
                                                <button class="btn btn-secondary btn-sm"
                                                        @onclick="() => showAddItem = false">Cancel
                                                </button>
                                            </div>
                                        </div>
                                    }


                                    <div class="d-flex flex-column gap-3">
                                        @foreach (var item in categoryItems.GetValueOrDefault(category.Id, new List<MenuItem>()))
                                        {
                                            <MenuItemEditComponent
                                                Item="item"
                                                Categories="categories"
                                                Tags="tags"
                                                OnSave="SaveItem"
                                                OnDelete="DeleteItem"
                                                OnMove="HandleMoveItem"/>
                                        }
                                    </div>
                                </div>
                            }
                        </li>
                    }
                </ul>
            </div>
        </div>

        <!-- UNCATEGORIZED ITEMS -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Uncategorized Items</h5>
                <button class="btn btn-sm btn-outline-secondary" @onclick="ToggleUncategorized">
                    @(showUncategorized ? "Collapse" : "Expand")
                </button>
            </div>
            @if (showUncategorized)
            {
                <div class="card-body">
                    <button class="btn btn-primary btn-sm mb-2" @onclick="() => ShowAddItemForm(null)">Add Item</button>

                    <ul class="list-group">
                        @foreach (var item in uncategorizedItems)
                        {
                            <li class="list-group-item">
                                <MenuItemEditComponent
                                    Item="item"
                                    Categories="categories"
                                    OnSave="SaveItem"
                                    OnDelete="DeleteItem"
                                    OnMove="HandleMoveItem"/>
                            </li>
                        }
                    </ul>
                </div>
            }
        </div>
    </div>
}
else
{
    <div class="text-center mt-4">
        <button class="btn btn-success" @onclick="CreateMenu">Add Menu</button>
    </div>
}
