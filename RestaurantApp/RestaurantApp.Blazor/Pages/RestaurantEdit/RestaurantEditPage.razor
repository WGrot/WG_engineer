@page "/restaurant/edit/{Id:int}"
@implements IDisposable

@using RestaurantApp.Shared.Models
@using RestaurantApp.Blazor.Components
@using RestaurantApp.Blazor.Services
@using RestaurantApp.Blazor.Services.Interfaces
@using RestaurantApp.Shared.DTOs.Restaurant
@using Microsoft.AspNetCore.Components.Authorization
@using RestaurantApp.Blazor.Components.Layout
@inject HttpClient Http
@inject PermissionService PermissionService
@inject ICurrentUserDataService UserDataService


<AuthorizeView>
    <Authorized>
        <div class="edit-container">

            @if (_restaurant == null)
            {
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>Loading...</p>
                </div>
            }
            else
            {
                <RestaurantHeader Restaurant=@_restaurant/>
                <div class="bg-light border-bottom sticky-top">
                    <div class="container">
                        <ul class="nav nav-tabs border-0 pt-2" role="tablist">
                            <li class="nav-item">
                                <button
                                    class="nav-link @(_activeTab == "basic" ? "active" : "") px-4 py-3 border-0 rounded-top"
                                    @onclick="@(() => _activeTab = "basic")"
                                    type="button">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Basic Info
                                </button>
                            </li>
                            @if (_canManageTables)
                            {
                                <li class="nav-item">
                                    <button
                                        class="nav-link @(_activeTab == "tables" ? "active" : "") px-4 py-3 border-0 rounded-top"
                                        @onclick="@(() => _activeTab = "tables")"
                                        type="button">
                                        <i class="bi bi-grid-3x3-gap me-2"></i>
                                        Tables
                                    </button>
                                </li>
                            }
                            @if (_canManageSettigns)
                            {
                                <li class="nav-item">
                                    <button
                                        class="nav-link @(_activeTab == "settings" ? "active" : "") px-4 py-3 border-0 rounded-top"
                                        @onclick="@(() => _activeTab = "settings")"
                                        type="button">
                                        <i class="bi bi-gear"></i>
                                        Settings
                                    </button>
                                </li>
                            }
                            @if (_canManageEmployees)
                            {
                                <li class="nav-item">
                                    <button
                                        class="nav-link @(_activeTab == "employees" ? "active" : "") px-4 py-3 border-0 rounded-top"
                                        @onclick="@(() => _activeTab = "employees")"
                                        type="button">
                                        <i class="bi bi-people"></i>
                                        Employees
                                    </button>
                                </li>
                            }
                            @if (_canManageMenu)
                            {
                                <li class="nav-item">
                                    <button
                                        class="nav-link @(_activeTab == "menu" ? "active" : "") px-4 py-3 border-0 rounded-top"
                                        @onclick="@(() => _activeTab = "menu")"
                                        type="button">
                                        <i class="bi bi-book me-2"></i>
                                        Menu
                                    </button>
                                </li>
                            }
                            @if (_canManageRestaurant)
                            {
                                <li class="nav-item">
                                    <button
                                        class="nav-link @(_activeTab == "appearance" ? "active" : "") px-4 py-3 border-0 rounded-top"
                                        @onclick="@(() => _activeTab = "appearance")"
                                        type="button">
                                        <i class="bi bi-stars"></i>
                                        Appearance
                                    </button>
                                </li>
                            }

                        </ul>
                    </div>
                </div>

                <div class="container my-4">
                    <div class="tab-content">
                        @switch (_activeTab)
                        {
                            case "basic":
                                <BasicInfoTab Id=@Id Restaurant=@_restaurant/>
                                break;
                            case "tables":
                                <TablesTab Id=@Id Restaurant=@_restaurant/>
                                break;
                            case "settings":
                                <RestaurantSettingsTab Id=@Id Restaurant=@_restaurant/>
                                break;
                            case "employees":
                                <RestaurantEmployeesTab Id=@Id Restaurant=@_restaurant/>
                                break;
                            case "menu":
                                <MenuTab Id=@Id Restaurant=@_restaurant/>
                                break;
                            case "appearance":
                                <AppearanceTab Id=@Id Restaurant=@_restaurant/>
                                break;
                        }
                    </div>
                </div>
            }
        </div>
    </Authorized>
    <NotAuthorized>
        <RedirectToLogin
            UseReturnUrl="true"/>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter] public int Id { get; set; }
    private RestaurantDto? _restaurant;
    private bool _isLoading = true;
    string _activeTab = "basic";

    bool _canManageMenu ;
    bool _canManageTables ;
    bool _canManageRestaurant ;
    bool _canManageSettigns ;
    bool _canManageEmployees ;

    protected override async Task OnInitializedAsync()
    {
        await LoadRestaurant();
        await GetUserPermissions();
    }

    private async Task LoadRestaurant()
    {
        try
        {
            Id = int.Parse((await UserDataService.GetActiveRestaurant())!);
            _restaurant = await Http.GetFromJsonAsync<RestaurantDto>($"api/restaurant/{Id}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading restaurant: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }

        StateHasChanged();
    }

    private async Task GetUserPermissions()
    {
        _canManageMenu = await PermissionService.HasPermissionAsync(Id, PermissionTypeEnumDto.ManageMenu.ToString());
        _canManageRestaurant = await PermissionService.HasPermissionAsync(Id, PermissionTypeEnumDto.ManageRestaurant.ToString());
        _canManageSettigns = await PermissionService.HasPermissionAsync(Id, PermissionTypeEnumDto.ManageRestaurantSettings.ToString());
        _canManageTables = await PermissionService.HasPermissionAsync(Id, PermissionTypeEnumDto.ManageTables.ToString());
        _canManageEmployees = await PermissionService.HasAnyPermissionAsync(Id, new[] { PermissionTypeEnumDto.ManageEmployees.ToString(), PermissionTypeEnumDto.ManagePermissions.ToString() });
    }

    public void Dispose()
    {
    }

}
