@using RestaurantApp.Shared.DTOs.OpeningHours
@using RestaurantApp.Shared.DTOs.Restaurant
@inject HttpClient Http

<div class="container mt-4">
    <div class="col d-flex justify-content-center">

        <div class="card-body">
            <div class="d-flex flex-column gap-3">
                @foreach (var day in Enum.GetValues<DayOfWeek>())
                {
                    var hours = GetOrCreateOpeningHours(day);
                    <div class="border rounded p-3 bg-light">
                        <div class="row align-items-center">

                            <div class="col-12 col-md-3 mb-2 mb-md-0">
                                <strong>@day</strong>
                            </div>

                            <div class="col-12 col-md-6 mb-2 mb-md-0">
                                @if (!hours.IsClosed)
                                {
                                    <div class="d-flex align-items-center gap-2">
                                        <input type="time"
                                               class="form-control form-control-sm"
                                               value="@hours.OpenTime.ToString("HH:mm")"
                                               @oninput="e => OnTimeChanged(hours, e, true)"/>
                                        <span class="fw-bold">—</span>
                                        <input type="time"
                                               class="form-control form-control-sm"
                                               value="@hours.CloseTime.ToString("HH:mm")"
                                               @oninput="e => OnTimeChanged(hours, e, false)"/>
                                    </div>
                                }
                                else
                                {
                                    <div class="d-flex align-items-center justify-content-center gap-2">
                                        <span class="badge bg-secondary py-2 w-50">Closed</span>
                                    </div>
                                }
                            </div>

                            <div class="col-12 col-md-3">
                                <button class="w-100 @(hours.IsClosed ? "base-button" : "grey-button")"
                                        @onclick="() => ToggleClosed(hours)">
                                    @(hours.IsClosed ? "Open" : "Close")
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>

            @if (_changesMade)
            {
                <div class="mt-4 d-flex justify-content-center gap-2">
                    <button class="base-button" @onclick="SaveChanges">
                        <i class="bi bi-arrow-down-right-circle me-2"></i> Save
                    </button>
                    <button class="grey-button" @onclick="CancelChanges">
                        Cancel
                    </button>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }
    [Parameter] public required RestaurantDto Restaurant { get; set; }
    private RestaurantDto _modifiedRestaurant = new RestaurantDto();
    private bool _changesMade = false;

    protected override void OnInitialized()
    {
        InitializeOpeningHours();
    }

    
    private void OnTimeChanged(OpeningHoursDto hours, ChangeEventArgs e, bool isOpenTime)
    {
        if (TimeOnly.TryParse(e.Value?.ToString(), out var time))
        {
            if (isOpenTime)
                hours.OpenTime = time;
            else
                hours.CloseTime = time;
        
            _changesMade = true;
            StateHasChanged();
        }
    }
    private void InitializeOpeningHours()
    {
        _modifiedRestaurant = new RestaurantDto
        {
            Id = Restaurant.Id,
            OpeningHours = new List<OpeningHoursDto>()
        };

        if (Restaurant.OpeningHours?.Count == 7)
        {
            foreach (var originalHours in Restaurant.OpeningHours)
            {
                _modifiedRestaurant.OpeningHours.Add(new OpeningHoursDto
                {
                    DayOfWeek = originalHours.DayOfWeek,
                    OpenTime = originalHours.OpenTime,
                    CloseTime = originalHours.CloseTime,
                    IsClosed = originalHours.IsClosed,
                    RestaurantId = Restaurant.Id
                });
            }
        }
        else
        {
            foreach (var day in Enum.GetValues<DayOfWeek>())
            {
                _modifiedRestaurant.OpeningHours.Add(new OpeningHoursDto
                {
                    DayOfWeek = day,
                    OpenTime = new TimeOnly(10, 0),
                    CloseTime = new TimeOnly(22, 0),
                    IsClosed = day == DayOfWeek.Sunday,
                    RestaurantId = Restaurant.Id
                });
            }
        }
    }

    private OpeningHoursDto GetOrCreateOpeningHours(DayOfWeek day)
    {
        var hours = _modifiedRestaurant.OpeningHours?.FirstOrDefault(h => h.DayOfWeek == day);
        if (hours == null)
        {
            hours = new OpeningHoursDto
            {
                DayOfWeek = day,
                OpenTime = new TimeOnly(10, 0),
                CloseTime = new TimeOnly(22, 0),
                RestaurantId = _modifiedRestaurant.Id
            };
            _modifiedRestaurant.OpeningHours ??= new List<OpeningHoursDto>();
            _modifiedRestaurant.OpeningHours.Add(hours);
        }

        return hours!;
    }

    private void ToggleClosed(OpeningHoursDto hours)
    {
        _changesMade = true;
        hours.IsClosed = !hours.IsClosed;
    }

    private void CancelChanges()
    {
        _changesMade = false;
        InitializeOpeningHours();
    }

    private async Task SaveChanges()
    {
        try
        {
            await Http.PatchAsJsonAsync($"api/restaurant/{Id}/opening-hours", _modifiedRestaurant.OpeningHours);

            Restaurant.OpeningHours = _modifiedRestaurant.OpeningHours!.Select(h => new OpeningHoursDto
            {
                DayOfWeek = h.DayOfWeek,
                OpenTime = h.OpenTime,
                CloseTime = h.CloseTime,
                IsClosed = h.IsClosed,
                RestaurantId = h.RestaurantId
            }).ToList();

            _changesMade = false;
        }
        catch (Exception e)
        {
            Console.WriteLine($"Error saving opening hours: {e.Message}");
        }
    }

}