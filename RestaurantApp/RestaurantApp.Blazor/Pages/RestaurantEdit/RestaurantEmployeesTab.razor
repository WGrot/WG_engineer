@using RestaurantApp.Shared.Models
@using System.Net.Http.Json
@using RestaurantApp.Blazor.Models.DTO
@using RestaurantApp.Blazor.Components
@using RestaurantApp.Blazor.Extensions
@using RestaurantApp.Shared.DTOs
@using RestaurantApp.Shared.DTOs.Employees
@using RestaurantApp.Shared.DTOs.Restaurant
@inject HttpClient Http
@inject NavigationManager Navigation

<div class="d-flex justify-content-center">
    <button @onclick="OpenAddEmployeeModal" class="button--primary button--lg button  mb-3 me-3 w-50">Add new employee</button>
    <button @onclick="OpenSearchEmployeeModal" class="button--primary button button--lg mb-3 w-50">Search for existing employee accounts</button>
</div>

<AddEmployeeModal
    @bind-IsVisible="showAddEmployeeModal"
    RestaurantId="Id"
    OnEmployeeAdded="HandleEmployeeAdded"
    Title="Dodaj nowego pracownika" />

<SearchUserModal
    @bind-IsVisible="showSearch"
    RestaurantId="Id"
    Title="Search for existing employee accounts" />

<ManagePermissionsModal
    @bind-IsVisible="showPermissionsModal"
    Employee="selectedEmployee"
    RestaurantId="Id"
    OnPermissionsUpdated="HandlePermissionsUpdated" />

<GenericModal @bind-IsVisible="showSuccessModal"
              Title="Employee added successfully"
              Size="GenericModal.ModalSize.Small">
    <ChildContent>
        @if (newEmployeeResponse != null)
        {
            <div class="text-center">
                <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                <div class="mt-3">
                    <p class="mb-2"><strong>Employee account created</strong></p>
                    <p class="mb-1">Email: <strong>@newEmployeeResponse.Email</strong></p>
                    <p >Email with additional info was sent to employee inbox</p>
                </div>
            </div>
        }
    </ChildContent>
    <FooterContent>
        <button class="btn btn-primary" @onclick="() => showSuccessModal = false">OK</button>
    </FooterContent>
</GenericModal>

@if (isLoading)
{
    <div class="text-center">
        <div class="spinner-border" role="statusEnumDto">
            <span class="visually-hidden">Loading employees...</span>
        </div>
    </div>
}
else if (error != null)
{
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle-fill"></i> Error: @error
    </div>
}
else if (employees == null || !employees.Any())
{
    <div class="alert alert-info">
        <i class="bi bi-info-circle-fill"></i> You don't have any employees yet.
    </div>
}
else
{
    <div class="row">
        @foreach (var employee in employees)
        {
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card reservation-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-person-fill"></i> @employee.FirstName @employee.LastName
                        </h5>
                        <div class="card-text">
                            <p class="mb-1">
                                <i class="bi bi-envelope"></i>
                                <small>@employee.Email</small>
                            </p>
                            <p class="mb-2">
                                <i class="bi bi-telephone"></i>
                                <small>@(employee.PhoneNumber ?? "No phone number")</small>
                            </p>
                            @if (!string.IsNullOrEmpty(employee.RoleEnumDto.ToString()))
                            {
                                <p class="mb-2">
                                    <span class="badge bg-secondary">@employee.RoleEnumDto</span>
                                </p>
                            }
                        </div>
                        <div class="d-flex gap-2">
                            <button class="button button--primary button--outline flex-fill"
                                    @onclick="() => OpenPermissionsModal(employee)">
                                <i class=" me-1 bi bi-shield-lock"></i> Manage Permissions
                            </button>
                            <button class="button button--red button--outline"
                                    @onclick="() => RemoveEmployee(employee)"
                                    title="Delete Employee">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
    
    <ConfirmationModal
        @bind-IsVisible="showDeleteConfirmModal"
        Title="Delete Employee"
        Message="@GetDeleteMessage()"
        IsProcessing="isDeleting"
        ConfirmButtonText="Delete"
        OnConfirm="ConfirmRemoveEmployee"
        OnCancel="CancelRemoveEmployee" />
}

@code {
    [Parameter] public int Id { get; set; }
    [Parameter] public RestaurantDto? restaurant { get; set; }

    private bool isLoading = true;
    private string? error;
    private List<RestaurantEmployeeDto> employees = new List<RestaurantEmployeeDto>();
    
    private bool showSearch = false;
    private bool showAddEmployeeModal = false;
    private bool showSuccessModal = false;
    private bool showPermissionsModal = false;
    
    private bool showDeleteConfirmModal = false;
    private bool isDeleting = false;
    private RestaurantEmployeeDto? employeeToDelete;
    
    private CreateUserResponse? newEmployeeResponse;
    private RestaurantEmployeeDto? selectedEmployee;

    protected override async Task OnInitializedAsync()
    {
        await LoadEmployees();
    }

    private async Task LoadEmployees()
    {
        isLoading = true;
        error = null;

        try
        {
            var response = await Http.GetFromJsonAsync<List<RestaurantEmployeeDto>>($"/api/Employees?restaurantId={Id}");
            employees = response;

        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading employees: {ex.Message}");
            error = "Failed to load employees";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OpenAddEmployeeModal()
    {
        showAddEmployeeModal = true;
    }

    private void OpenSearchEmployeeModal()
    {
        showSearch = true;
    }
    
    private void OpenPermissionsModal(RestaurantEmployeeDto employee)
    {
        selectedEmployee = employee;
        showPermissionsModal = true;
    }

    private async Task HandleEmployeeAdded(CreateUserResponse response)
    {
        await LoadEmployees();
        newEmployeeResponse = response;
        showSuccessModal = true;
    }

    private async Task HandlePermissionsUpdated()
    {
        await LoadEmployees();
    }
    
    private string GetDeleteMessage()
    {
        if (employeeToDelete == null)
            return "Are you sure you want to delete this employee?";
    
        return $"Are you sure you want to delete employee {employeeToDelete.FirstName} {employeeToDelete.LastName}?";
    }

    private void RemoveEmployee(RestaurantEmployeeDto employee)
    {
        employeeToDelete = employee;
        showDeleteConfirmModal = true;
    }

    private async Task ConfirmRemoveEmployee()
    {
        if (employeeToDelete == null)
            return;

        isDeleting = true;

        try
        {
            var response = await Http.DeleteAsync($"api/Employees/{employeeToDelete.Id}");

            if (response.IsSuccessStatusCode)
            {
                await LoadEmployees();
            }
            else
            {
                error = "Failed to delete employee";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error removing employee: {ex.Message}");
            error = "An error occurred while deleting the employee";
        }
        finally
        {
            isDeleting = false;
            showDeleteConfirmModal = false;
            employeeToDelete = null;
        }
    }

    private void CancelRemoveEmployee()
    {
        employeeToDelete = null;
        showDeleteConfirmModal = false;
    }
}