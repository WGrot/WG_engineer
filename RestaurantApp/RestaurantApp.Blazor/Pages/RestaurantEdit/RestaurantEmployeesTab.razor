
@using RestaurantApp.Blazor.Models.DTO
@using RestaurantApp.Blazor.Components
@using RestaurantApp.Blazor.Services
@using RestaurantApp.Shared.DTOs.Employees
@using RestaurantApp.Shared.DTOs.Restaurant
@inject HttpClient Http
@inject NavigationManager Navigation
@inject MessageService MessageService

<div class="d-flex justify-content-center">
    <button @onclick="OpenAddEmployeeModal" class="button--primary button--lg button  mb-3 me-3 w-50">Add new employee</button>
    <button @onclick="OpenSearchEmployeeModal" class="button--primary button button--lg mb-3 w-50">Invite employees with existing accounts</button>
</div>

<AddEmployeeModal
    @bind-IsVisible="_showAddEmployeeModal"
    RestaurantId="Id"
    OnEmployeeAdded="HandleEmployeeAdded"
    Title="Add new employee account" />


<ManagePermissionsModal
    @bind-IsVisible="_showPermissionsModal"
    Employee="_selectedEmployee"
    RestaurantId="Id"
    OnPermissionsUpdated="HandlePermissionsUpdated" />

<SentInvitationModal @bind-IsVisible="_showSearch"
                     RestaurantId="@Id"/>

<GenericModal @bind-IsVisible="_showSuccessModal"
              Title="Employee added successfully"
              Size="GenericModal.ModalSize.Small">
    <ChildContent>
        @if (_newEmployeeResponse != null)
        {
            <div class="text-center">
                <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                <div class="mt-3">
                    <p class="mb-1">Email: <strong>@_newEmployeeResponse.Email</strong></p>
                    <p >Email with additional info was sent to employee inbox</p>
                </div>
            </div>
        }
    </ChildContent>
    <FooterContent>
        <button class="btn btn-primary" @onclick="() => _showSuccessModal = false">OK</button>
    </FooterContent>
</GenericModal>

@if (_isLoading)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading employees...</span>
        </div>
    </div>
}
else if (_error != null)
{
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle-fill"></i> Error: @_error
    </div>
}
else if (!_employees.Any())
{
    <div class="alert alert-info">
        <i class="bi bi-info-circle-fill"></i> You don't have any employees yet.
    </div>
}
else
{
    <div class="row">
        @foreach (var employee in _employees)
        {
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card reservation-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-person-fill"></i> @employee.FirstName @employee.LastName
                        </h5>
                        <div class="card-text">
                            <p class="mb-1">
                                <i class="bi bi-envelope"></i>
                                <small>@employee.Email</small>
                            </p>
                            <p class="mb-2">
                                <i class="bi bi-telephone"></i>
                                <small>@(employee.PhoneNumber ?? "No phone number")</small>
                            </p>
                            @if (!string.IsNullOrEmpty(employee.RoleEnumDto.ToString()))
                            {
                                <p class="mb-2">
                                    <span class="badge bg-secondary">@employee.RoleEnumDto</span>
                                </p>
                            }
                        </div>
                        <div class="d-flex gap-2">
                            <button class="button button--primary button--outline flex-fill"
                                    @onclick="() => OpenPermissionsModal(employee)">
                                <i class=" me-1 bi bi-shield-lock"></i> Manage Permissions
                            </button>
                            <button class="button button--red button--outline"
                                    @onclick="() => RemoveEmployee(employee)"
                                    title="Delete Employee">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
    
    <ConfirmationModal
        @bind-IsVisible="_showDeleteConfirmModal"
        Title="Delete Employee"
        Message="@GetDeleteMessage()"
        IsProcessing="_isDeleting"
        ConfirmButtonText="Delete"
        OnConfirm="ConfirmRemoveEmployee"
        OnCancel="CancelRemoveEmployee" />
}

@code {
    [Parameter] public int Id { get; set; }
    [Parameter] public RestaurantDto? Restaurant { get; set; }

    private bool _isLoading = true;
    private string? _error;
    private List<RestaurantEmployeeDto> _employees = new List<RestaurantEmployeeDto>();
    
    private bool _showSearch = false;
    private bool _showAddEmployeeModal = false;
    private bool _showSuccessModal = false;
    private bool _showPermissionsModal = false;
    
    private bool _showDeleteConfirmModal = false;
    private bool _isDeleting = false;
    private RestaurantEmployeeDto? _employeeToDelete;
    
    private CreateUserResponse? _newEmployeeResponse;
    private RestaurantEmployeeDto? _selectedEmployee;

    protected override async Task OnInitializedAsync()
    {
        await LoadEmployees();
    }

    private async Task LoadEmployees()
    {
        _isLoading = true;
        _error = null;

        try
        {
            var response = await Http.GetFromJsonAsync<List<RestaurantEmployeeDto>>($"/api/Employees?restaurantId={Id}");
            if (response != null) _employees = response;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading employees: {ex.Message}");
            _error = "Failed to load employees";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void OpenAddEmployeeModal()
    {
        _showAddEmployeeModal = true;
    }

    private void OpenSearchEmployeeModal()
    {
        _showSearch = true;
    }
    
    private void OpenPermissionsModal(RestaurantEmployeeDto employee)
    {
        _selectedEmployee = employee;
        _showPermissionsModal = true;
    }



    private async Task HandleEmployeeAdded(CreateUserResponse response)
    {
        await LoadEmployees();
        _newEmployeeResponse = response;
        _showSuccessModal = true;
    }

    private async Task HandlePermissionsUpdated()
    {
        await LoadEmployees();
    }
    
    private string GetDeleteMessage()
    {
        if (_employeeToDelete == null)
            return "Are you sure you want to delete this employee?";
    
        return $"Are you sure you want to delete employee {_employeeToDelete.FirstName} {_employeeToDelete.LastName}?";
    }

    private void RemoveEmployee(RestaurantEmployeeDto employee)
    {
        _employeeToDelete = employee;
        _showDeleteConfirmModal = true;
    }

    private async Task ConfirmRemoveEmployee()
    {
        if (_employeeToDelete == null)
            return;

        _isDeleting = true;

        try
        {
            var response = await Http.DeleteAsync($"api/Employees/{_employeeToDelete.Id}");

            if (response.IsSuccessStatusCode)
            {
                await LoadEmployees();
                MessageService.AddSuccess("Success", "Employee deleted successfully");
            }
            else
            {
                MessageService.AddError("Error", "Failed to delete employee");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error removing employee: {ex.Message}");
            MessageService.AddError("Error", "Failed to delete employee");
        }
        finally
        {
            _isDeleting = false;
            _showDeleteConfirmModal = false;
            _employeeToDelete = null;
        }
    }

    private void CancelRemoveEmployee()
    {
        _employeeToDelete = null;
        _showDeleteConfirmModal = false;
    }
}