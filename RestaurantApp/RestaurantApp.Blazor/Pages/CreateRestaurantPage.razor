@page "/CreateRestaurant"
@using Microsoft.AspNetCore.Components.Authorization
@using RestaurantApp.Blazor.Services
@using RestaurantApp.Blazor.Services.Interfaces
@using RestaurantApp.Shared.DTOs.GeoCoding
@using RestaurantApp.Shared.DTOs.Restaurant
@inject NavigationManager Navigation
@inject AuthService AuthService
@inject HttpClient Http
@inject MessageService MessageService

<AuthorizeView>
    <Authorized>
        <div class="container-fluid d-flex flex-column justify-content-center align-items-center vh-100 text-center text-white bg-primary p-4 shadow-lg">
            <h1 class="mb-3">Create Your Restaurant Profile</h1>
            <h5 class="mb-4">
                Fill out the form below to register your restaurant. After that proceed to restaurant edit page to add more details.
            </h5>

            <form class="w-100" style="max-width: 400px;" @onsubmit="CreateRestaurant">
                <h3 class="text-center">Restaurant name</h3>
                <div class="mb-3 text-start">
                    <label for="restaurantName" class="form-label">Restaurant Name</label>
                    <input type="text" class="form-control" id="restaurantName" @bind="restaurantName" placeholder="Enter restaurant name">
                </div>

                <h3 class="text-center">Restaurant Address data</h3>

                <div class="mb-3 text-start">
                    <label for="street" class="form-label">Street</label>
                    <input type="text" class="form-control" id="street" @bind="addressDto.Street" placeholder="Enter restaurant address">
                </div>

                <div class="mb-3 text-start">
                    <label for="city" class="form-label">City</label>
                    <input type="text" class="form-control" id="city" @bind="addressDto.City" placeholder="Enter restaurant address">
                </div>

                <div class="mb-3 text-start">
                    <label for="postal" class="form-label">Postal Code</label>
                    <input type="text" class="form-control" id="postal" @bind="addressDto.PostalCode" placeholder="Enter restaurant address">
                </div>

                <div class="mb-3 text-start">
                    <label for="country" class="form-label">Country</label>
                    <input type="text" class="form-control" id="country" @bind="addressDto.Country" placeholder="Enter restaurant address">
                </div>

                <button type="submit" class="button button--lg button--primary px-5 w-100">
                    Create Restaurant Profile
                </button>
            </form>
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="container-fluid d-flex flex-column justify-content-center align-items-center vh-100 text-center text-white bg-primary p-4 shadow-lg">
            <h1 class="mb-3">You need to be logged in and have a verified account to create a restaurant profile</h1>
            <h5 class="mb-4">
                To learn more about restaurant accounts, see
                <a href="/faq" class="text-warning text-decoration-underline">FAQ</a>
            </h5>
            <button class="button button--lg button--primary px-5" @onclick="GoToLogin">
                Log in
            </button>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {

    private string restaurantName = "";
    private StructuresAddressDto addressDto = new StructuresAddressDto();

    void GoToLogin()
    {
        var returnUrl = Uri.EscapeDataString(new Uri(Navigation.Uri).PathAndQuery);
        Navigation.NavigateTo($"/login?returnUrl={returnUrl}");
    }

    private async Task CreateRestaurant()
    {
        
        if (string.IsNullOrWhiteSpace(restaurantName))
        {
            MessageService.AddError("Incorrect data", "Restaurant name is required");
            return;
        }

        if (string.IsNullOrWhiteSpace(addressDto.Street))
        {
            MessageService.AddError("Incorrect data", "Street is required");
            return;
        }

        if (string.IsNullOrWhiteSpace(addressDto.City))
        {
            MessageService.AddError("Incorrect data", "City name is required");
            return;
        }

        if (string.IsNullOrWhiteSpace(addressDto.PostalCode))
        {
            MessageService.AddError("Incorrect data", "Postal Code is required");
            return;
        }

        if (string.IsNullOrWhiteSpace(addressDto.Country))
        {
            MessageService.AddError("Incorrect data", "Country name is required");
            return;
        }
        
        var restaurantDto = new CreateRestaurantDto
        {
            Name = restaurantName,
            Address = "",
            StructuresAddress = addressDto
        };

        var response = await Http.PostAsJsonAsync("api/Restaurant/create-as-user", restaurantDto);
        if (response.IsSuccessStatusCode)
        {
            MessageService.AddSuccess("Success", "Restaurant created successfully, you will be logged out to refresh your permissions.");
            await Task.Delay(1500);
            await AuthService.LogoutAsync();
        }
        else
        {
            var errorMessage = (int)response.StatusCode switch
            {
                422 => "Geocoding error, try correcting the address",
                _ => "Failed to create restaurant. Please try again."
            };
            MessageService.AddError("Error", errorMessage);
        }
    }
}